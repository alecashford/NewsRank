require 'spec_helper'

describe '#fetch' do
  it "makes a request to the Reddit endpoint" do
    reddit = stub_request(:get, "http://www.reddit.com/api/info.json?url=http://www.brushnewstribune.com/ci_26167090/council-receives-request-revisit-marijuana-moratorium").to_return(status: 200, body: "stubbed response", headers: {})
    client = GetScores::RedditFetcher.new("http://www.brushnewstribune.com/ci_26167090/council-receives-request-revisit-marijuana-moratorium")
    client.fetch
    expect(reddit).to have_been_requested
  end

  it "returns nil if the endpoint raises an error" do
    reddit = stub_request(:get, "http://www.reddit.com/api/info.json?url=http://www.brushnewstribune.com/ci_26167090/council-receives-request-revisit-marijuana-moratorium").to_raise(StandardError.new("any error"))
    client = GetScores::RedditFetcher.new("http://www.brushnewstribune.com/ci_26167090/council-receives-request-revisit-marijuana-moratorium")
    expect(client.fetch).to eq(nil)
  end

  it "returns nil if the endpoint has a status of 500" do
    reddit = stub_request(:get, "http://www.reddit.com/api/info.json?url=http://www.brushnewstribune.com/ci_26167090/council-receives-request-revisit-marijuana-moratorium").to_return(:status => [500, "Internal Server Error"])
    client = GetScores::RedditFetcher.new("http://www.brushnewstribune.com/ci_26167090/council-receives-request-revisit-marijuana-moratorium")
    expect(client.fetch).to eq(nil)
  end
end

describe '#scores' do
  it "returns a hash of values" do
    reddit = stub_request(:get, "http://www.reddit.com/api/info.json?url=http://www.brushnewstribune.com/ci_26167090/council-receives-request-revisit-marijuana-moratorium").to_return(status: 200, body: body = '{"kind": "Listing", "data": {"modhash": "", "children": [{"kind": "t3", "data": {"domain": "brushnewstribune.com", "banned_by": null, "media_embed": {}, "subreddit": "news", "selftext_html": null, "selftext": "", "likes": null, "secure_media": null, "link_flair_text": null, "id": "2c1id1", "gilded": 0, "secure_media_embed": {}, "clicked": false, "stickied": false, "author": "NYU_FOOTBALL_RULES", "media": null, "score": 3164, "approved_by": null, "over_18": false, "hidden": false, "thumbnail": "", "subreddit_id": "t5_2qh3l", "edited": false, "link_flair_css_class": null, "author_flair_css_class": null, "downs": 0, "saved": false, "is_self": false, "permalink": "/r/news/comments/2c1id1/man_buys_correctional_facility_in_colorado_wants/", "name": "t3_2c1id1", "created": 1406644911.0, "url": "http://www.brushnewstribune.com/ci_26167090/council-receives-request-revisit-marijuana-moratorium", "author_flair_text": null, "title": "Man buys correctional facility in Colorado. Wants to turn it into a marijuana factory.", "created_utc": 1406641311.0, "ups": 3164, "num_comments": 251, "visited": false, "num_reports": null, "distinguished": null}}, {"kind": "t3", "data": {"domain": "brushnewstribune.com", "banned_by": null, "media_embed": {}, "subreddit": "Colorado", "selftext_html": null, "selftext": "", "likes": null, "secure_media": null, "link_flair_text": null, "id": "2c2iol", "gilded": 0, "secure_media_embed": {}, "clicked": false, "stickied": false, "author": "drocks27", "media": null, "score": 21, "approved_by": null, "over_18": false, "hidden": false, "thumbnail": "default", "subreddit_id": "t5_2qhkb", "edited": false, "link_flair_css_class": null, "author_flair_css_class": null, "downs": 0, "saved": false, "is_self": false, "permalink": "/r/Colorado/comments/2c2iol/man_buys_correctional_facility_in_colorado_wants/", "name": "t3_2c2iol", "created": 1406690325.0, "url": "http://www.brushnewstribune.com/ci_26167090/council-receives-request-revisit-marijuana-moratorium", "author_flair_text": null, "title": "Man buys correctional facility in Colorado. Wants to turn it into a marijuana factory.", "created_utc": 1406661525.0, "ups": 21, "num_comments": 0, "visited": false, "num_reports": null, "distinguished": null}}, {"kind": "t3", "data": {"domain": "brushnewstribune.com", "banned_by": null, "media_embed": {}, "subreddit": "JoeRogan", "selftext_html": null, "selftext": "", "likes": null, "secure_media": null, "link_flair_text": null, "id": "2c22ss", "gilded": 0, "secure_media_embed": {}, "clicked": false, "stickied": false, "author": "were_rare", "media": null, "score": 13, "approved_by": null, "over_18": false, "hidden": false, "thumbnail": "default", "subreddit_id": "t5_2s4tv", "edited": false, "link_flair_css_class": null, "author_flair_css_class": null, "downs": 0, "saved": false, "is_self": false, "permalink": "/r/JoeRogan/comments/2c22ss/farmer_buys_former_prison_and_requests_ability_to/", "name": "t3_2c22ss", "created": 1406682016.0, "url": "http://www.brushnewstribune.com/ci_26167090/council-receives-request-revisit-marijuana-moratorium", "author_flair_text": null, "title": "Farmer buys former prison and requests ability to grow Marijuana on the grounds", "created_utc": 1406653216.0, "ups": 13, "num_comments": 1, "visited": false, "num_reports": null, "distinguished": null}}, {"kind": "t3", "data": {"domain": "brushnewstribune.com", "banned_by": null, "media_embed": {}, "subreddit": "POLITIC", "selftext_html": null, "selftext": "", "likes": null, "secure_media": null, "link_flair_text": "news|NYU_FOOTBALL_RULES", "id": "2c1igr", "gilded": 0, "secure_media_embed": {}, "clicked": false, "stickied": false, "author": "PoliticBot", "media": null, "score": 1, "approved_by": null, "over_18": false, "hidden": false, "thumbnail": "default", "subreddit_id": "t5_2r84s", "edited": false, "link_flair_css_class": "meta", "author_flair_css_class": "politic-bot", "downs": 0, "saved": false, "is_self": false, "permalink": "/r/POLITIC/comments/2c1igr/man_buys_correctional_facility_in_colorado_wants/", "name": "t3_2c1igr", "created": 1406670173.0, "url": "http://www.brushnewstribune.com/ci_26167090/council-receives-request-revisit-marijuana-moratorium", "author_flair_text": "mirrors political submissions", "title": "Man buys correctional facility in Colorado. Wants to turn it into a marijuana factory.", "created_utc": 1406641373.0, "ups": 1, "num_comments": 1, "visited": false, "num_reports": null, "distinguished": null}}], "after": null, "before": null}}', headers: {:content_type => 'application/json'})
    client = GetScores::RedditFetcher.new("http://www.brushnewstribune.com/ci_26167090/council-receives-request-revisit-marijuana-moratorium")
    expect(client.scores).to be_a(Hash)
  end

  it "returns the correct score" do
    body = '{"kind": "Listing", "data": {"modhash": "", "children": [{"kind": "t3", "data": {"domain": "brushnewstribune.com", "banned_by": null, "media_embed": {}, "subreddit": "news", "selftext_html": null, "selftext": "", "likes": null, "secure_media": null, "link_flair_text": null, "id": "2c1id1", "gilded": 0, "secure_media_embed": {}, "clicked": false, "stickied": false, "author": "NYU_FOOTBALL_RULES", "media": null, "score": 3164, "approved_by": null, "over_18": false, "hidden": false, "thumbnail": "", "subreddit_id": "t5_2qh3l", "edited": false, "link_flair_css_class": null, "author_flair_css_class": null, "downs": 0, "saved": false, "is_self": false, "permalink": "/r/news/comments/2c1id1/man_buys_correctional_facility_in_colorado_wants/", "name": "t3_2c1id1", "created": 1406644911.0, "url": "http://www.brushnewstribune.com/ci_26167090/council-receives-request-revisit-marijuana-moratorium", "author_flair_text": null, "title": "Man buys correctional facility in Colorado. Wants to turn it into a marijuana factory.", "created_utc": 1406641311.0, "ups": 3164, "num_comments": 251, "visited": false, "num_reports": null, "distinguished": null}}, {"kind": "t3", "data": {"domain": "brushnewstribune.com", "banned_by": null, "media_embed": {}, "subreddit": "Colorado", "selftext_html": null, "selftext": "", "likes": null, "secure_media": null, "link_flair_text": null, "id": "2c2iol", "gilded": 0, "secure_media_embed": {}, "clicked": false, "stickied": false, "author": "drocks27", "media": null, "score": 21, "approved_by": null, "over_18": false, "hidden": false, "thumbnail": "default", "subreddit_id": "t5_2qhkb", "edited": false, "link_flair_css_class": null, "author_flair_css_class": null, "downs": 0, "saved": false, "is_self": false, "permalink": "/r/Colorado/comments/2c2iol/man_buys_correctional_facility_in_colorado_wants/", "name": "t3_2c2iol", "created": 1406690325.0, "url": "http://www.brushnewstribune.com/ci_26167090/council-receives-request-revisit-marijuana-moratorium", "author_flair_text": null, "title": "Man buys correctional facility in Colorado. Wants to turn it into a marijuana factory.", "created_utc": 1406661525.0, "ups": 21, "num_comments": 0, "visited": false, "num_reports": null, "distinguished": null}}, {"kind": "t3", "data": {"domain": "brushnewstribune.com", "banned_by": null, "media_embed": {}, "subreddit": "JoeRogan", "selftext_html": null, "selftext": "", "likes": null, "secure_media": null, "link_flair_text": null, "id": "2c22ss", "gilded": 0, "secure_media_embed": {}, "clicked": false, "stickied": false, "author": "were_rare", "media": null, "score": 13, "approved_by": null, "over_18": false, "hidden": false, "thumbnail": "default", "subreddit_id": "t5_2s4tv", "edited": false, "link_flair_css_class": null, "author_flair_css_class": null, "downs": 0, "saved": false, "is_self": false, "permalink": "/r/JoeRogan/comments/2c22ss/farmer_buys_former_prison_and_requests_ability_to/", "name": "t3_2c22ss", "created": 1406682016.0, "url": "http://www.brushnewstribune.com/ci_26167090/council-receives-request-revisit-marijuana-moratorium", "author_flair_text": null, "title": "Farmer buys former prison and requests ability to grow Marijuana on the grounds", "created_utc": 1406653216.0, "ups": 13, "num_comments": 1, "visited": false, "num_reports": null, "distinguished": null}}, {"kind": "t3", "data": {"domain": "brushnewstribune.com", "banned_by": null, "media_embed": {}, "subreddit": "POLITIC", "selftext_html": null, "selftext": "", "likes": null, "secure_media": null, "link_flair_text": "news|NYU_FOOTBALL_RULES", "id": "2c1igr", "gilded": 0, "secure_media_embed": {}, "clicked": false, "stickied": false, "author": "PoliticBot", "media": null, "score": 1, "approved_by": null, "over_18": false, "hidden": false, "thumbnail": "default", "subreddit_id": "t5_2r84s", "edited": false, "link_flair_css_class": "meta", "author_flair_css_class": "politic-bot", "downs": 0, "saved": false, "is_self": false, "permalink": "/r/POLITIC/comments/2c1igr/man_buys_correctional_facility_in_colorado_wants/", "name": "t3_2c1igr", "created": 1406670173.0, "url": "http://www.brushnewstribune.com/ci_26167090/council-receives-request-revisit-marijuana-moratorium", "author_flair_text": "mirrors political submissions", "title": "Man buys correctional facility in Colorado. Wants to turn it into a marijuana factory.", "created_utc": 1406641373.0, "ups": 1, "num_comments": 1, "visited": false, "num_reports": null, "distinguished": null}}], "after": null, "before": null}}'
    reddit = stub_request(:get, "http://www.reddit.com/api/info.json?url=http://www.brushnewstribune.com/ci_26167090/council-receives-request-revisit-marijuana-moratorium").to_return(status: 200, body: body, headers: {:content_type => 'application/json'})
    client = GetScores::RedditFetcher.new("http://www.brushnewstribune.com/ci_26167090/council-receives-request-revisit-marijuana-moratorium")
    p client.fetch
    expect(client.scores[:score]).to eq(3199)
  end
end